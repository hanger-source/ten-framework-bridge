# 实际代码迁移 - 2: 具体修改步骤

## 步骤1: 创建接口文件

```typescript
// ai_agents/playground/src/interfaces/IRTCClient.ts
export interface IRTCClient {
  join(channel: string, token: string, uid: string): Promise<void>;
  leave(): Promise<void>;
  createAudioTrack(): Promise<IAudioTrack>;
  createVideoTrack(): Promise<IVideoTrack>;
  publish(): Promise<void>;
  destroy(): void;
  on(event: string, handler: Function): void;
}

export interface IAudioTrack {
  play(element?: HTMLElement): void;
  stop(): void;
  close(): void;
  setEnabled(enabled: boolean): void;
}

export interface IVideoTrack {
  play(element?: HTMLElement): void;
  stop(): void;
  close(): void;
  setEnabled(enabled: boolean): void;
}
```

## 步骤2: 创建适配器文件

```typescript
// ai_agents/playground/src/adapters/AgoraRTCAdapter.ts
import AgoraRTC, { IAgoraRTCClient } from "agora-rtc-sdk-ng";
import { IRTCClient, IAudioTrack, IVideoTrack } from "../interfaces/IRTCClient";

export class AgoraRTCAdapter implements IRTCClient {
  private client: IAgoraRTCClient;

  constructor() {
    this.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
  }

  async join(channel: string, token: string, uid: string): Promise<void> {
    await this.client.join(token, channel, uid);
  }

  async leave(): Promise<void> {
    await this.client.leave();
  }

  async createAudioTrack(): Promise<IAudioTrack> {
    return await AgoraRTC.createMicrophoneAudioTrack();
  }

  async createVideoTrack(): Promise<IVideoTrack> {
    return await AgoraRTC.createCameraVideoTrack();
  }

  async publish(): Promise<void> {
    // 实现发布逻辑
  }

  destroy(): void {
    this.client.removeAllListeners();
  }

  on(event: string, handler: Function): void {
    this.client.on(event, handler);
  }
}
```

## 步骤3: 修改现有 RTCManager

```typescript
// ai_agents/playground/src/components/RTCManager.ts
import { IRTCClient } from "../interfaces/IRTCClient";
import { RTCClientFactory } from "../factories/RTCClientFactory";

export class RTCManager {
  private client: IRTCClient;

  constructor(rtcType: string = "agora") {
    this.client = RTCClientFactory.create(rtcType);
  }

  async join(channel: string, token: string, uid: string): Promise<void> {
    await this.client.join(channel, token, uid);
  }

  async leave(): Promise<void> {
    await this.client.leave();
  }

  async createAudioTrack(): Promise<IAudioTrack> {
    return await this.client.createAudioTrack();
  }

  async createVideoTrack(): Promise<IVideoTrack> {
    return await this.client.createVideoTrack();
  }

  async publish(): Promise<void> {
    await this.client.publish();
  }

  destroy(): void {
    this.client.destroy();
  }

  on(event: string, handler: Function): void {
    this.client.on(event, handler);
  }
}
```

## 步骤4: 更新环境变量

```env
# .env.local
NEXT_PUBLIC_RTC_TYPE=agora
NEXT_PUBLIC_AGORA_APP_ID=your_agora_app_id
NEXT_PUBLIC_ALI_APP_ID=your_ali_app_id
```

## 步骤5: 更新 package.json

```json
{
  "dependencies": {
    "agora-rtc-sdk-ng": "^4.20.0",
    "dingrtc": "^1.0.0"
  }
}
```
