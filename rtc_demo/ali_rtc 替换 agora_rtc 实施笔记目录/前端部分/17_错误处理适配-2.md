# 错误处理适配 - 2: 错误适配器

## 错误适配器实现

```typescript
// adapters/ErrorAdapter.ts
import { UnifiedError, UnifiedErrorCode } from "../interfaces/UnifiedError";

export class ErrorAdapter {
  static adaptError(error: any, rtcType: string): UnifiedError {
    if (rtcType === "ali") {
      return this.adaptAliError(error);
    } else {
      return this.adaptAgoraError(error);
    }
  }

  private static adaptAliError(error: any): UnifiedError {
    const code = this.mapErrorCode(error.code, "ali");
    return {
      code,
      message: error.message || this.getErrorMessage(code),
      originalError: error,
      rtcType: "ali",
    };
  }

  private static adaptAgoraError(error: any): UnifiedError {
    const code = this.mapErrorCode(error.code, "agora");
    return {
      code,
      message: error.message || this.getErrorMessage(code),
      originalError: error,
      rtcType: "agora",
    };
  }

  private static mapErrorCode(
    originalCode: string,
    rtcType: string
  ): UnifiedErrorCode {
    const mapping = {
      // Agora 错误码映射
      OPERATION_ABORTED: "OPERATION_CANCELLED",
      INVALID_ARGUMENT: "INVALID_PARAMETER",
      NOT_SUPPORTED: "NOT_SUPPORTED",
      NETWORK_ERROR: "NETWORK_ERROR",
      PERMISSION_DENIED: "PERMISSION_DENIED",
      OPERATION_TIMEOUT: "OPERATION_TIMEOUT",
      OPERATION_FAILED: "OPERATION_FAILED",

      // 阿里云错误码映射
      OPERATION_CANCELLED: "OPERATION_CANCELLED",
      INVALID_PARAMETER: "INVALID_PARAMETER",
      NOT_SUPPORTED: "NOT_SUPPORTED",
      NETWORK_ERROR: "NETWORK_ERROR",
      PERMISSION_DENIED: "PERMISSION_DENIED",
      OPERATION_TIMEOUT: "OPERATION_TIMEOUT",
      OPERATION_FAILED: "OPERATION_FAILED",
    };

    return mapping[originalCode] || "UNKNOWN_ERROR";
  }

  private static getErrorMessage(code: UnifiedErrorCode): string {
    const messages = {
      OPERATION_CANCELLED: "操作被取消",
      INVALID_PARAMETER: "参数无效",
      NOT_SUPPORTED: "不支持的操作",
      NETWORK_ERROR: "网络错误",
      PERMISSION_DENIED: "权限被拒绝",
      OPERATION_TIMEOUT: "操作超时",
      OPERATION_FAILED: "操作失败",
      UNKNOWN_ERROR: "未知错误",
    };

    return messages[code] || "未知错误";
  }
}
```

## 使用示例

```typescript
// 在事件监听中使用错误适配器
client.on("error", (error) => {
  const unifiedError = ErrorAdapter.adaptError(error, "agora");
  console.error("统一错误:", unifiedError);

  // 根据统一错误码处理
  switch (unifiedError.code) {
    case "OPERATION_CANCELLED":
      console.log("操作被取消");
      break;
    case "INVALID_PARAMETER":
      console.log("参数无效");
      break;
    case "NETWORK_ERROR":
      console.log("网络错误，尝试重连");
      break;
    default:
      console.log("其他错误:", unifiedError.message);
  }
});
```

## 错误处理工具函数

```typescript
// utils/errorHandler.ts
export class ErrorHandler {
  static handleRTCError(error: any, rtcType: string) {
    const unifiedError = ErrorAdapter.adaptError(error, rtcType);

    // 记录错误日志
    console.error(`[${rtcType.toUpperCase()}] 错误:`, unifiedError);

    // 根据错误类型采取不同处理策略
    this.handleByErrorType(unifiedError);
  }

  private static handleByErrorType(error: UnifiedError) {
    switch (error.code) {
      case "NETWORK_ERROR":
        this.handleNetworkError(error);
        break;
      case "PERMISSION_DENIED":
        this.handlePermissionError(error);
        break;
      case "OPERATION_TIMEOUT":
        this.handleTimeoutError(error);
        break;
      default:
        this.handleGenericError(error);
    }
  }

  private static handleNetworkError(error: UnifiedError) {
    // 网络错误处理逻辑
    console.log("处理网络错误:", error.message);
  }

  private static handlePermissionError(error: UnifiedError) {
    // 权限错误处理逻辑
    console.log("处理权限错误:", error.message);
  }

  private static handleTimeoutError(error: UnifiedError) {
    // 超时错误处理逻辑
    console.log("处理超时错误:", error.message);
  }

  private static handleGenericError(error: UnifiedError) {
    // 通用错误处理逻辑
    console.log("处理通用错误:", error.message);
  }
}
```
