# 具体代码修改步骤 - 1: 前端核心文件修改

## 1. RTCManager.ts 修改

### 1.1 导入语句修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
import AgoraRTC, { IAgoraRTCClient } from "agora-rtc-sdk-ng";
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
import DingRTC, { DingRTCClient } from "dingrtc";
```

### 1.2 客户端创建修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
export class RtcManager extends AGEventEmitter<RtcEvents> {
  private _joined;
  client: IAgoraRTCClient;
  localTracks: IUserTracks;
  appId: string | null = null;
  token: string | null = null;
  userId: number | null = null;

  constructor() {
    super();
    this._joined = false;
    this.localTracks = {};
    this.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    this._listenRtcEvents();
  }
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
export class RtcManager extends AGEventEmitter<RtcEvents> {
  private _joined;
  client: DingRTCClient;
  localTracks: IUserTracks;
  appId: string | null = null;
  token: string | null = null;
  userId: number | null = null;

  constructor() {
    super();
    this._joined = false;
    this.localTracks = {};
    this.client = DingRTC.createClient();
    this._listenRtcEvents();
  }
```

### 1.3 轨道创建修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
async createMicrophoneAudioTrack() {
  try {
    const audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
    this.localTracks.audioTrack = audioTrack;
  } catch (err) {
    console.error("Failed to create audio track", err);
  }
  this.emit("localTracksChanged", this.localTracks);
}

async createCameraTracks() {
  try {
    const videoTrack = await AgoraRTC.createCameraVideoTrack();
    this.localTracks.videoTrack = videoTrack;
  } catch (err) {
    console.error("Failed to create video track", err);
  }
  this.emit("localTracksChanged", this.localTracks);
}
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
async createMicrophoneAudioTrack() {
  try {
    const audioTrack = await this.client.createMicrophoneAudioTrack();
    this.localTracks.audioTrack = audioTrack;
  } catch (err) {
    console.error("Failed to create audio track", err);
  }
  this.emit("localTracksChanged", this.localTracks);
}

async createCameraTracks() {
  try {
    const videoTrack = await this.client.createCameraVideoTrack();
    this.localTracks.videoTrack = videoTrack;
  } catch (err) {
    console.error("Failed to create video track", err);
  }
  this.emit("localTracksChanged", this.localTracks);
}

async createScreenShareTrack() {
  try {
    const screenTrack = await this.client.createScreenVideoTrack({
      dimension: 'VD_1280x720',
      frameRate: 15,
    });
    this.localTracks.screenTrack = screenTrack;
  } catch (err) {
    console.error("Failed to create screen track", err);
  }
  this.emit("localTracksChanged", this.localTracks);
}
```

### 1.4 数据通道事件监听修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
private _listenRtcEvents() {
  this.client.on("stream-message", (uid: UID, stream: any) => {
    this._parseData(stream);
  });
}
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
private _listenRtcEvents() {
  // 阿里云RTC对应的数据通道事件监听
  this.client.on("stream-message", (uid: UID, stream: any) => {
    this._parseData(stream);
  });
}
```

### 1.6 加入房间修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
async join({ channel, userId, agentSettings }: { channel: string; userId: number; agentSettings?: any }) {
  if (!this._joined) {
    let appId: string;
    let finalToken: string;

    if (agentSettings?.token) {
      appId = agentSettings?.env?.AGORA_APP_ID || process.env.NEXT_PUBLIC_AGORA_APP_ID || '';
      finalToken = agentSettings.token;
    } else {
      const res = await apiGenRtcData({ channel, userId, rtcType: "ali" });
      const { code, data } = res;
      if (code != 0) {
        throw new Error("Failed to get Ali RTC token");
      }
      appId = data.appId;
      finalToken = data.token;
    }

    await this.client?.join({
      appId,
      token: finalToken,
      uid: userId,
      channel,
      userName: `user-${userId}`,
    });
    this._joined = true;
  }
}
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtc/rtc.ts
async join({ channel, userId, agentSettings }: { channel: string; userId: number; agentSettings?: any }) {
  if (!this._joined) {
    let appId: string;
    let finalToken: string;

    if (agentSettings?.token) {
      appId = agentSettings?.env?.ALI_RTC_APP_ID || process.env.NEXT_PUBLIC_ALI_RTC_APP_ID || '';
      finalToken = agentSettings.token;
    } else {
      const res = await apiGenRtcData({ channel, userId, rtcType: "ali" });
      const { code, data } = res;
      if (code != 0) {
        throw new Error("Failed to get Ali RTC token");
      }
      appId = data.appId;
      finalToken = data.token;
    }

    await this.client?.join({
      appId,
      token: finalToken,
      uid: userId,
      channel,
      userName: `user-${userId}`,
    });
    this._joined = true;
  }
}
```

## 2. useRTC.ts Hook 修改

### 2.1 类型定义修改

**修改前**:

```typescript
// ai_agents/playground/src/hooks/useRTC.ts
import { IAgoraRTCClient } from "agora-rtc-sdk-ng";

export const useRTC = () => {
  const [client, setClient] = useState<IAgoraRTCClient | null>(null);
  // ...
};
```

**修改后**:

```typescript
// ai_agents/playground/src/hooks/useRTC.ts
import { DingRTCClient } from "dingrtc";

export const useRTC = () => {
  const [client, setClient] = useState<DingRTCClient | null>(null);
  // ...
};
```

### 2.2 客户端创建修改

**修改前**:

```typescript
// ai_agents/playground/src/hooks/useRTC.ts
const createClient = useCallback(() => {
  const rtcClient = AgoraRTC.createClient({
    mode: "rtc",
    codec: "vp8",
  });
  setClient(rtcClient);
}, []);
```

**修改后**:

```typescript
// ai_agents/playground/src/hooks/useRTC.ts
const createClient = useCallback(() => {
  const rtcClient = DingRTC.createClient();
  setClient(rtcClient);
}, []);
```

### 2.3 轨道创建修改

**修改前**:

```typescript
// ai_agents/playground/src/hooks/useRTC.ts
const createAudioTrack = useCallback(async () => {
  const audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
  return audioTrack;
}, []);

const createVideoTrack = useCallback(async () => {
  const videoTrack = await AgoraRTC.createCameraVideoTrack();
  return videoTrack;
}, []);
```

**修改后**:

```typescript
// ai_agents/playground/src/hooks/useRTC.ts
const createAudioTrack = useCallback(async () => {
  if (!client) return null;
  const audioTrack = await client.createMicrophoneAudioTrack();
  return audioTrack;
}, [client]);

const createVideoTrack = useCallback(async () => {
  if (!client) return null;
  const videoTrack = await client.createCameraVideoTrack();
  return videoTrack;
}, [client]);
```

## 3. request.ts 修改

### 3.1 API 调用修改

**修改前**:

```typescript
// ai_agents/playground/src/common/request.ts
export const apiGenAgoraData = async (config: GenAgoraDataConfig) => {
  const url = `/api/token/generate`;
  const { userId, channel } = config;
  const data = {
    request_id: genUUID(),
    uid: userId,
    channel_name: channel,
  };
  let resp: any = await axios.post(url, data);
  resp = resp.data || {};
  return resp;
};
```

**修改后**:

```typescript
// ai_agents/playground/src/common/request.ts
export const apiGenRtcData = async (config: GenRtcDataConfig) => {
  const url = `/api/token/generate`;
  const { userId, channel, rtcType = "ali" } = config;
  const data = {
    request_id: genUUID(),
    uid: userId,
    channel_name: channel,
  };

  const params = new URLSearchParams({ rtcType });
  let resp: any = await axios.post(`${url}?${params}`, data);
  resp = resp.data || {};
  return resp;
};

// 保持向后兼容
export const apiGenAgoraData = async (config: GenAgoraDataConfig) => {
  return apiGenRtcData({ ...config, rtcType: "agora" });
};
```

### 3.2 类型定义修改

**修改前**:

```typescript
// ai_agents/playground/src/common/request.ts
interface GenAgoraDataConfig {
  userId: string | number;
  channel: string;
}
```

**修改后**:

```typescript
// ai_agents/playground/src/common/request.ts
interface GenRtcDataConfig {
  userId: string | number;
  channel: string;
  rtcType?: "agora" | "ali";
}

interface GenAgoraDataConfig {
  userId: string | number;
  channel: string;
}
```

## 4. 环境变量配置

### 4.1 .env 文件修改

**修改前**:

```bash
# .env
NEXT_PUBLIC_AGORA_APP_ID=your_agora_app_id
```

**修改后**:

```bash
# .env
NEXT_PUBLIC_ALI_RTC_APP_ID=your_ali_rtc_app_id
NEXT_PUBLIC_ALI_RTC_APP_KEY=your_ali_rtc_app_key
```

### 4.2 配置读取修改

**修改前**:

```typescript
// ai_agents/playground/src/config/rtc.ts
export const rtcConfig = {
  appId: process.env.NEXT_PUBLIC_AGORA_APP_ID || "",
};
```

**修改后**:

```typescript
// ai_agents/playground/src/config/rtc.ts
export const rtcConfig = {
  appId: process.env.NEXT_PUBLIC_ALI_RTC_APP_ID || "",
  appKey: process.env.NEXT_PUBLIC_ALI_RTC_APP_KEY || "",
};
```

## 5. 事件监听修改

### 5.1 用户事件修改

**修改前**:

```typescript
// ai_agents/playground/src/components/RTCManager.ts
client.on("user-joined", (user) => {
  console.log("用户加入:", user.uid);
});

client.on("user-left", (user) => {
  console.log("用户离开:", user.uid);
});
```

**修改后**:

```typescript
// ai_agents/playground/src/components/RTCManager.ts
client.on("user-joined", (user) => {
  console.log("用户加入:", user.userId);
});

client.on("user-left", (user) => {
  console.log("用户离开:", user.userId);
});
```

## 6. 错误处理修改

### 6.1 错误码修改

**修改前**:

```typescript
// ai_agents/playground/src/components/RTCManager.ts
try {
  await this.client?.join(appId, channel, finalToken, userId);
} catch (error) {
  if (error.code === "OPERATION_INVALID_TOKEN") {
    console.error("Token 无效");
  }
}
```

**修改后**:

```typescript
// ai_agents/playground/src/components/RTCManager.ts
try {
  await this.client?.join({
    appId,
    token: finalToken,
    uid: userId,
    channel,
    userName: `user-${userId}`,
  });
} catch (error) {
  if (error.code === "INVALID_TOKEN") {
    console.error("Token 无效");
  }
}
```

## 7. 关键修改要点

### 7.1 必须修改的文件

1. `ai_agents/playground/src/manager/rtc/rtc.ts`
2. `ai_agents/playground/src/hooks/useRTC.ts`
3. `ai_agents/playground/src/common/request.ts`
4. `ai_agents/playground/src/config/rtc.ts`
5. `.env` 环境变量文件

### 7.2 修改顺序

1. 先修改环境变量配置
2. 再修改 API 调用
3. 然后修改客户端创建
4. 最后修改事件监听

### 7.3 注意事项

1. **保持向后兼容**: 保留原有的 `apiGenAgoraData` 函数
2. **错误处理**: 适配阿里云 RTC 的错误码
3. **类型安全**: 更新所有相关的类型定义
