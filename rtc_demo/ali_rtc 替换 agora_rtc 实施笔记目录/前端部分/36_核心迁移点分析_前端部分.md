# 核心迁移点分析 - 前端部分

## 1. 前端 RTC 客户端

**位置**: `ai_agents/playground/src/manager/rtc/rtc.ts`

**核心功能**:

- 使用 Agora RTC SDK 连接音视频
- 需要替换为使用阿里云 RTC SDK

**关键差异**:

- Agora: `agora-rtc-sdk-ng`
- 阿里云: `dingrtc`

**具体迁移点**:

- 客户端创建: `AgoraRTC.createClient({ mode: "rtc", codec: "vp8" })` → `DingRTC.createClient()`
- 轨道创建:
  - `AgoraRTC.createCameraVideoTrack()` → `client.createCameraVideoTrack()`
  - `AgoraRTC.createMicrophoneAudioTrack()` → `client.createMicrophoneAudioTrack()`
  - `AgoraRTC.createScreenVideoTrack()` → `client.createScreenVideoTrack()`
- 房间加入: `client.join(appId, channel, token, uid)` → `client.join({appId, token, uid, channel, userName})`
- 类型定义: `IAgoraRTCClient` → `DingRTCClient`
- 事件监听:
  - `client.on("user-published")` → 阿里云对应的事件
  - `client.on("user-unpublished")` → 阿里云对应的事件
  - `client.on("stream-message")` → 阿里云对应的事件
- 轨道管理:
  - `client.publish(tracks)` → 阿里云对应的发布方式
  - `client.unpublish(track)` → 阿里云对应的取消发布方式
  - `client.subscribe(user, mediaType)` → 阿里云对应的订阅方式

## 2. 前端 RTM 消息传递

**位置**: `ai_agents/playground/src/manager/rtm/index.ts`

**核心功能**:

- 使用 Agora RTM SDK 传递AI和用户消息流
- 处理流式文本消息和二进制消息
- 支持消息分片和重组

**关键发现**:

- **双通道架构**: Agora使用RTC + RTM双通道
  - RTC: 负责音视频传输
  - RTM: 负责消息传递（AI流式输出、用户输入等）
- **消息类型**: 支持STRING和BINARY两种消息类型
- **流式处理**: 支持消息分片，处理大消息的流式传输
- **事件监听**: 监听message和presence事件
- **消息格式**: 使用JSON格式，包含is_final、ts、text、type、stream_id等字段
- **自定义类型**: 支持customType字段，当前使用"PainTxt"

**具体迁移点**:

- RTM客户端创建: `new AgoraRTM.RTM(appId, String(userId))` → `new RTM()`
- 用户登录: `rtm.login({ token })` → 阿里云RTM对应的登录方式
- 频道订阅: `rtm.subscribe(channel, options)` → 阿里云RTM对应的订阅方式
- 消息发布: `rtm.publish(channel, message, { customType })` → 阿里云RTM对应的发布方式
- 事件监听: `addEventListener("message")` → 阿里云RTM对应的事件监听
- 消息处理: 需要保持JSON格式和字段结构不变

## 3. 前端 Token 获取

**位置**: `ai_agents/playground/src/common/request.ts`

**核心功能**:

- 调用 `/api/token/generate` 获取 token
- 需要替换为阿里云 RTC Token 获取

## 4. 前端 RTM 管理器

**位置**: `ai_agents/playground/src/manager/rtm/index.ts`

**核心功能**:

- 使用 Agora RTM SDK 管理消息传递
- 处理 STRING 和 BINARY 两种消息类型
- 支持消息订阅、发布和事件监听
