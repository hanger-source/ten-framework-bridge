# 房间连接对比

## 加入房间

### Agora RTC 加入房间

```typescript
// 加入房间
await this.client.join(token, channel, uid);

// 发布轨道
await this.client.publish([this.localAudioTrack, this.localVideoTrack]);
```

### 阿里云RTC 加入房间

```typescript
// 加入房间 - 需要传入对象参数
await this.client.join({
  appId: appId,
  token: token,
  uid: uid,
  channel: channel,
  userName: userName, // 阿里云RTC需要userName参数
});

// 发布轨道
await this.client.publish([this.localAudioTrack, this.localVideoTrack]);
```

## 用户标识差异

### Agora RTC 用户标识

```typescript
// 用户标识使用 uid
this.client.on("user-joined", (user) => {
  console.log("User joined:", user.uid);
});

this.client.on("user-left", (user) => {
  console.log("User left:", user.uid);
});
```

### 阿里云RTC 用户标识

```typescript
// 用户标识使用 userId
this.client.on("user-joined", (user) => {
  console.log("User joined:", user.userId);
});

this.client.on("user-left", (user) => {
  console.log("User left:", user.userId);
});
```

## 连接参数对比

| 项目     | Agora RTC           | 阿里云RTC |
| -------- | ------------------- | --------- |
| Token    | 必需                | 必需      |
| Channel  | 必需                | 必需      |
| UID      | 必需                | 必需      |
| AppId    | 必需                | 必需      |
| UserName | 可选                | 必需      |
| 参数顺序 | token, channel, uid | 对象参数  |

## 关键迁移差异

### 1. 参数结构差异

```typescript
// Agora RTC - 位置参数
await client.join(appId, channel, token, uid);

// 阿里云RTC - 对象参数
await client.join({
  appId: appId,
  token: token,
  uid: uid,
  channel: channel,
  userName: userName,
});
```

### playground 具体修改点

```typescript
// 文件: ai_agents/playground/src/manager/rtc/rtc.ts

// 从:
await this.client?.join(appId, channel, finalToken, userId);

// 到:
await this.client?.join({
  appId: appId,
  channel: channel,
  uid: userId,
  userName: `user_${userId}`, // 阿里云需要userName参数
  token: finalToken,
});
```

### 重要发现：参数顺序差异

根据源码分析，阿里云 DingRTC 的 join 方法参数顺序与 Agora 不同：

**Agora RTC**:
```typescript
await client.join(appId, channel, token, uid);
```

**阿里云 DingRTC**:
```typescript
await client.join({
  appId,
  channel,
  uid,
  userName, // 阿里云特有参数
  token,
});
```

**关键差异**:
1. 阿里云使用对象参数，而不是位置参数
2. 阿里云需要 `userName` 参数
3. 参数顺序：`appId`, `channel`, `uid`, `userName`, `token`

### 验证：根据源码分析

从 `rtc_demo/ali_rtc_demo/AliRTCSample/Web/reactVersion/src/pages/Welcome/components/Join.tsx` 第77行：

```typescript
const result = await newClient.join({
  appId: loginParam.appId,
  token: loginParam.appToken,
  uid: loginParam.userId,
  channel: loginParam.channelName,
  userName: loginParam.userName,
});
```

从 `rtc_demo/ali_rtc_demo/AliRTCSample/Web/reactVersion/src/utils/networkQuality.ts` 第43行：

```typescript
await uplinkClient.join({
  appId,
  channel,
  uid: userIdA,
  userName: userNameA,
  token,
});
```

### 2. 用户标识差异

```typescript
// Agora RTC - 使用 uid
user.uid;

// 阿里云RTC - 使用 userId
user.userId;
```

### 3. 客户端配置对比

**Agora RTC**:

```typescript
// 创建客户端时配置
const client = AgoraRTC.createClient({
  mode: "rtc",
  codec: "vp8",
});
```

**阿里云RTC** (根据[官方文档](https://help.aliyun.com/document_detail/2674351.html)):

```typescript
// 创建客户端
const client = DingRTC.createClient();

// 设置客户端配置
DingRTC.setClientConfig({
  // 全局配置参数
});
```

### 4. 连接状态管理对比

**Agora RTC**:

```typescript
client.on("connection-state-change", (curState, prevState) => {
  console.log("连接状态变化:", prevState, "->", curState);
});
```

**阿里云RTC**:

```typescript
client.on("connection-state-change", (curState, prevState, reason) => {
  console.log("连接状态变化:", prevState, "->", curState, reason);
});
```

## 连接状态管理

### Agora RTC 连接状态

```typescript
// 连接状态监听
this.client.on("connection-state-change", (curState, prevState) => {
  console.log("Connection state:", prevState, "->", curState);
});

// 连接状态枚举
enum ConnectionState {
  DISCONNECTED = "DISCONNECTED",
  CONNECTING = "CONNECTING",
  CONNECTED = "CONNECTED",
  RECONNECTING = "RECONNECTING",
  ABORTED = "ABORTED",
}
```

### 阿里云RTC 连接状态

```typescript
// 连接状态监听
this.client.on("connection-state-change", (curState, prevState) => {
  console.log("Connection state:", prevState, "->", curState);
});

// 连接状态枚举
enum ConnectionState {
  DISCONNECTED = "DISCONNECTED",
  CONNECTING = "CONNECTING",
  CONNECTED = "CONNECTED",
  RECONNECTING = "RECONNECTING",
  ABORTED = "ABORTED",
}
```

## 错误处理对比

### Agora RTC 错误处理

```typescript
try {
  await this.client.join(token, channel, uid);
} catch (error) {
  console.error("Failed to join Agora channel:", error);
  // 处理连接错误
}
```

### 阿里云RTC 错误处理

```typescript
try {
  await this.client.join({
    appId: appId,
    token: token,
    uid: uid,
    channel: channel,
    userName: userName,
  });
} catch (error) {
  console.error("Failed to join Ali RTC channel:", error);
  // 处理连接错误
}
```

## 离开房间

### Agora RTC 离开房间

```typescript
// 离开房间
await this.client.leave();

// 清理资源
this.localAudioTrack?.close();
this.localVideoTrack?.close();
```

### 阿里云RTC 离开房间

```typescript
// 离开房间
await this.client.leave();

// 清理资源
this.localAudioTrack?.close();
this.localVideoTrack?.close();
```

## 实际迁移影响

### 代码修改

```typescript
// 迁移前 - Agora RTC
await this.client.join(token, channel, uid);
this.client.on("user-joined", (user) => {
  console.log("User joined:", user.uid);
});

// 迁移后 - 阿里云RTC
await this.client.join(token, channel, uid);
this.client.on("user-joined", (user) => {
  console.log("User joined:", user.userId);
});
```

### 用户标识处理

```typescript
// 迁移前 - 使用 uid
const userId = user.uid;

// 迁移后 - 使用 userId
const userId = user.userId;
```

## 关键差异总结

### 1. 连接方式

- **Agora**: `client.join(token, channel, uid)`
- **阿里云**: `client.join({appId, token, uid, channel, userName})` (对象参数)

### 2. 用户标识

- **Agora**: 使用 `user.uid` 字段
- **阿里云**: 使用 `user.userId` 字段

### 3. 连接状态

- **Agora**: 连接状态管理相同
- **阿里云**: 连接状态管理相同

### 4. 错误处理

- **Agora**: 标准错误处理
- **阿里云**: 标准错误处理

### 5. 迁移要点

- 修改连接方式从参数列表到对象参数
- 添加必需的 `appId` 和 `userName` 参数
- 修改用户标识字段从 `uid` 到 `userId`
- 更新错误处理中的RTC类型标识
- 保持资源清理逻辑不变
