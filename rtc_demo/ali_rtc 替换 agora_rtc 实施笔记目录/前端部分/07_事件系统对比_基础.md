# 事件系统对比

## 用户事件

### Agora RTC 用户事件

```typescript
// 用户加入事件
client.on("user-joined", (user) => {
  console.log("用户加入:", user.uid);
});

// 用户离开事件
client.on("user-left", (user) => {
  console.log("用户离开:", user.uid);
});

// 用户发布轨道事件
client.on("user-published", async (user, mediaType) => {
  await client.subscribe(user, mediaType);
});

// 用户取消发布轨道事件
client.on("user-unpublished", (user) => {
  console.log("用户取消发布:", user.uid);
});

// 连接状态变化事件
client.on("connection-state-change", (curState, prevState) => {
  console.log("连接状态变化:", prevState, "->", curState);
});
```

### 阿里云RTC 用户事件

```typescript
// 用户加入事件
client.on("user-joined", (user) => {
  console.log("用户加入:", user.userId);
});

// 用户离开事件
client.on("user-left", (user) => {
  console.log("用户离开:", user.userId);
});

// 用户发布轨道事件
client.on("user-published", async (user, mediaType) => {
  await client.subscribe(user.userId, mediaType);
});

// 用户取消发布轨道事件
client.on("user-unpublished", (user) => {
  console.log("用户取消发布:", user.userId);
});

// 连接状态变化事件
client.on("connection-state-change", (curState, prevState) => {
  console.log("连接状态变化:", prevState, "->", curState);
});

// 网络质量变化事件
client.on("network-quality", (quality) => {
  console.log("网络质量:", quality);
});

// 音量指示器事件
client.on("volume-indicator", (speakers) => {
  console.log("正在说话的用户:", speakers);
});
```

### playground 具体修改点

```typescript
// 文件: ai_agents/playground/src/manager/rtc/rtc.ts

// 事件监听方法修改
private _listenRtcEvents() {
  // 网络质量事件 - 无需修改
  this.client.on("network-quality", (quality) => {
    this.emit("networkQuality", quality);
  });

  // 用户发布事件 - 需要修改订阅方法和用户标识
  this.client.on("user-published", async (user, mediaType) => {
    // 关键差异：阿里云使用 client.subscribe(userId, mediaType)
    // Agora 使用 client.subscribe(user, mediaType)
    await this.client.subscribe(user.userId, mediaType);
    if (mediaType === "audio") {
      this._playAudio(user.audioTrack);
    }
    this.emit("remoteUserChanged", {
      userId: user.userId, // 从 user.uid 改为 user.userId
      audioTrack: user.audioTrack,
      videoTrack: user.videoTrack,
    });
  });

  // 用户取消发布事件 - 需要修改取消订阅方法和用户标识
  this.client.on("user-unpublished", async (user, mediaType) => {
    // 关键差异：阿里云使用 client.unsubscribe(userId, mediaType)
    // Agora 使用 client.unsubscribe(user, mediaType)
    await this.client.unsubscribe(user.userId, mediaType);
    this.emit("remoteUserChanged", {
      userId: user.userId, // 从 user.uid 改为 user.userId
      audioTrack: user.audioTrack,
      videoTrack: user.videoTrack,
    });
  });

  // 流消息事件 - 无需修改
  this.client.on("stream-message", (uid: UID, stream: any) => {
    this._parseData(stream);
  });
}
```

## 错误事件

### Agora RTC 错误事件

```typescript
// 错误事件监听
client.on("error", (error) => {
  console.error("Agora RTC 错误:", error);

  switch (error.code) {
    case "OPERATION_ABORTED":
      console.log("操作被中止");
      break;
    case "INVALID_ARGUMENT":
      console.log("参数无效");
      break;
    case "NOT_SUPPORTED":
      console.log("不支持的操作");
      break;
    default:
      console.log("未知错误");
  }
});
```

### 阿里云RTC 错误事件

```typescript
// 错误事件监听
client.on("error", (error) => {
  console.error("阿里云 RTC 错误:", error);

  switch (error.code) {
    case "OPERATION_CANCELLED":
      console.log("操作被取消");
      break;
    case "INVALID_PARAMETER":
      console.log("参数无效");
      break;
    case "NOT_SUPPORTED":
      console.log("不支持的操作");
      break;
    default:
      console.log("未知错误");
  }
});
```

## 类型定义对比

### 用户对象类型定义

**Agora RTC**:

```typescript
interface AgoraUser {
  uid: string;
  hasAudio: boolean;
  hasVideo: boolean;
}
```

**阿里云RTC**:

```typescript
interface AliUser {
  userId: string;
  hasAudio: boolean;
  hasVideo: boolean;
}
```

### 媒体类型定义

**Agora RTC**:

```typescript
type AgoraMediaType = "audio" | "video";
```

**阿里云RTC**:

```typescript
type AliMediaType = "audio" | "video";
```

### 错误对象类型定义

**Agora RTC**:

```typescript
interface AgoraError {
  code: string;
  message: string;
  data?: any;
}
```

**阿里云RTC**:

```typescript
interface AliError {
  code: string;
  message: string;
  data?: any;
}
```

## 错误码映射

### Agora RTC 错误码

```typescript
type AgoraErrorCode =
  | "OPERATION_ABORTED"
  | "INVALID_ARGUMENT"
  | "NOT_SUPPORTED"
  | "NETWORK_ERROR"
  | "PERMISSION_DENIED";
```

### 阿里云RTC 错误码

```typescript
type AliErrorCode =
  | "OPERATION_CANCELLED"
  | "INVALID_PARAMETER"
  | "NOT_SUPPORTED"
  | "NETWORK_ERROR"
  | "PERMISSION_DENIED";
```

## 事件系统对比总结

| 项目       | Agora RTC           | 阿里云RTC             |
| ---------- | ------------------- | --------------------- |
| 用户标识   | `user.uid`          | `user.userId`         |
| 错误码命名 | `OPERATION_ABORTED` | `OPERATION_CANCELLED` |
| 参数命名   | `INVALID_ARGUMENT`  | `INVALID_PARAMETER`   |
| 事件结构   | 基本相同            | 基本相同              |
| 错误处理   | 标准错误对象        | 标准错误对象          |

## 实际迁移影响

### 代码修改

```typescript
// 迁移前 - Agora RTC
client.on("user-joined", (user) => {
  console.log("用户加入:", user.uid);
});

client.on("error", (error) => {
  if (error.code === "OPERATION_ABORTED") {
    console.log("操作被中止");
  }
});

// 迁移后 - 阿里云RTC
client.on("user-joined", (user) => {
  console.log("用户加入:", user.userId);
});

client.on("error", (error) => {
  if (error.code === "OPERATION_CANCELLED") {
    console.log("操作被取消");
  }
});
```

### 类型定义更新

```typescript
// 迁移前 - Agora RTC
interface User {
  uid: string;
  hasAudio: boolean;
  hasVideo: boolean;
}

// 迁移后 - 阿里云RTC
interface User {
  userId: string;
  hasAudio: boolean;
  hasVideo: boolean;
}
```

## 关键差异总结

### 1. 用户标识

- **Agora**: 使用 `user.uid` 字段
- **阿里云**: 使用 `user.userId` 字段

### 2. 错误码命名

- **Agora**: `OPERATION_ABORTED`、`INVALID_ARGUMENT`
- **阿里云**: `OPERATION_CANCELLED`、`INVALID_PARAMETER`

### 3. 事件结构

- **Agora**: 事件参数结构相对简单
- **阿里云**: 事件参数结构更丰富，包含更多信息

### 4. 迁移要点

- 修改用户标识字段从 `uid` 到 `userId`
- 更新错误码映射
- 保持事件监听逻辑不变
- 更新类型定义
