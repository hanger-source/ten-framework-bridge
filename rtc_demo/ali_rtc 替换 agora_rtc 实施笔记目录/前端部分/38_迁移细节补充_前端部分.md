# 迁移细节补充 - 前端部分

## 1. 前端RTC客户端迁移

**文件**: `ai_agents/playground/src/manager/rtc/rtc.ts`

### 1.1 导入语句修改

```typescript
// 修改前
import AgoraRTC, {
  IAgoraRTCClient,
  IMicrophoneAudioTrack,
  IRemoteAudioTrack,
  UID,
} from "agora-rtc-sdk-ng";

// 修改后
import DingRTC, {
  DingRTCClient,
  MicrophoneAudioTrack,
  RemoteAudioTrack,
  UID,
} from "dingrtc";
```

### 1.2 客户端创建修改

```typescript
// 修改前
export class RtcManager extends AGEventEmitter<RtcEvents> {
  client: IAgoraRTCClient;

  constructor() {
    this.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
  }
}

// 修改后
export class RtcManager extends AGEventEmitter<RtcEvents> {
  client: DingRTCClient;

  constructor() {
    this.client = DingRTC.createClient();
  }
}
```

### 1.3 轨道创建修改

```typescript
// 修改前
async createMicrophoneAudioTrack() {
  const audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
  this.localTracks.audioTrack = audioTrack;
}

async createCameraTracks() {
  const videoTrack = await AgoraRTC.createCameraVideoTrack();
  this.localTracks.videoTrack = videoTrack;
}

async createScreenShareTrack() {
  const screenTrack = await AgoraRTC.createScreenVideoTrack({
    encoderConfig: { width: 1200, height: 800, frameRate: 5 }
  }, "disable");
  this.localTracks.screenTrack = screenTrack;
}

// 修改后
async createMicrophoneAudioTrack() {
  const audioTrack = await DingRTC.createMicrophoneAudioTrack();
  this.localTracks.audioTrack = audioTrack;
}

async createCameraTracks() {
  const videoTrack = await DingRTC.createCameraVideoTrack();
  this.localTracks.videoTrack = videoTrack;
}

async createScreenShareTrack() {
  const screenTrack = await DingRTC.createScreenVideoTrack({
    encoderConfig: { width: 1200, height: 800, frameRate: 5 }
  });
  this.localTracks.screenTrack = screenTrack;
}
```

### 1.4 房间加入修改

```typescript
// 修改前
async join({ channel, userId, agentSettings }: { channel: string; userId: number; agentSettings?: any }) {
  if (!this._joined) {
    let appId: string;
    let finalToken: string;

    if (agentSettings?.token) {
      appId = agentSettings?.env?.AGORA_APP_ID || process.env.NEXT_PUBLIC_AGORA_APP_ID || '';
      finalToken = agentSettings.token;
    } else {
      const res = await apiGenAgoraData({ channel, userId });
      const { code, data } = res;
      if (code != 0) {
        throw new Error("Failed to get Agora token");
      }
      appId = data.appId;
      finalToken = data.token;
    }

    await this.client?.join(appId, channel, finalToken, userId);
    this._joined = true;
  }
}

// 修改后
async join({ channel, userId, agentSettings, rtcType = "agora" }: {
  channel: string;
  userId: number;
  agentSettings?: any;
  rtcType?: "agora" | "ali";
}) {
  if (!this._joined) {
    let appId: string;
    let finalToken: string;

    if (agentSettings?.token) {
      if (rtcType === "ali") {
        appId = agentSettings?.env?.ALI_APP_ID || process.env.NEXT_PUBLIC_ALI_APP_ID || '';
      } else {
        appId = agentSettings?.env?.AGORA_APP_ID || process.env.NEXT_PUBLIC_AGORA_APP_ID || '';
      }
      finalToken = agentSettings.token;
    } else {
      const res = await apiGenRtcData({ channel, userId, rtcType });
      const { code, data } = res;
      if (code != 0) {
        throw new Error(`Failed to get ${rtcType} token`);
      }
      appId = data.appId;
      finalToken = data.token;
    }

    if (rtcType === "ali") {
      await this.client?.join({
        appId,
        token: finalToken,
        uid: userId,
        channel,
        userName: `user_${userId}`
      });
    } else {
      await this.client?.join(appId, channel, finalToken, userId);
    }
    this._joined = true;
  }
}
```

### 1.5 事件监听修改

```typescript
// 修改前
this.client.on("user-published", async (user, mediaType) => {
  await this.client.subscribe(user, mediaType);
  this.emit("user-published", user, mediaType);
});

this.client.on("user-unpublished", (user, mediaType) => {
  this.emit("user-unpublished", user, mediaType);
});

// 修改后
this.client.on("user-published", async (user, mediaType) => {
  await this.client.subscribe(user, mediaType);
  this.emit("user-published", user, mediaType);
});

this.client.on("user-unpublished", (user, mediaType) => {
  this.emit("user-unpublished", user, mediaType);
});
```

## 2. 前端类型定义更新

### 2.1 类型定义修改

```typescript
// 修改前
import {
  IAgoraRTCClient,
  IMicrophoneAudioTrack,
  IRemoteAudioTrack,
} from "agora-rtc-sdk-ng";

interface LocalTracks {
  audioTrack?: IMicrophoneAudioTrack;
  videoTrack?: ICameraVideoTrack;
  screenTrack?: IScreenVideoTrack;
}

// 修改后
import { DingRTCClient, MicrophoneAudioTrack, RemoteAudioTrack } from "dingrtc";

interface LocalTracks {
  audioTrack?: MicrophoneAudioTrack;
  videoTrack?: CameraVideoTrack;
  screenTrack?: ScreenVideoTrack;
}
```

### 2.2 API请求修改

```typescript
// 修改前
export const apiGenAgoraData = async (config: GenAgoraDataConfig) => {
  const url = `/api/token/generate`;
  const { userId, channel } = config;
  const data = {
    request_id: genUUID(),
    uid: userId,
    channel_name: channel,
  };
  let resp: any = await axios.post(url, data);
  resp = resp.data || {};
  return resp;
};

// 修改后
export const apiGenRtcData = async (config: GenRtcDataConfig) => {
  const url = `/api/token/generate`;
  const { userId, channel, rtcType = "agora" } = config;
  const data = {
    request_id: genUUID(),
    uid: userId,
    channel_name: channel,
    rtcType,
  };
  let resp: any = await axios.post(url, data);
  resp = resp.data || {};
  return resp;
};
```

## 3. 前端配置更新

### 3.1 环境变量配置

```bash
# .env.local
NEXT_PUBLIC_AGORA_APP_ID=your_agora_app_id
NEXT_PUBLIC_ALI_APP_ID=your_ali_app_id
NEXT_PUBLIC_DEFAULT_RTC_TYPE=agora
```

### 3.2 配置对象更新

```typescript
// config/rtc.ts
export const rtcConfig = {
  agora: {
    appId: process.env.NEXT_PUBLIC_AGORA_APP_ID,
    token: null,
    channel: null,
    uid: null,
  },
  ali: {
    appId: process.env.NEXT_PUBLIC_ALI_APP_ID,
    token: null,
    channel: null,
    uid: null,
  },
  defaultType: process.env.NEXT_PUBLIC_DEFAULT_RTC_TYPE || "agora",
};
```
