# 环境变量配置完整指南

## 0. 重要发现：双RTC支持

通过分析代码发现，系统需要同时支持Agora RTC和阿里云RTC，而不是完全替换。这要求：

1. **保持向后兼容**: 现有的Agora RTC配置需要保留
2. **新增阿里云配置**: 添加阿里云RTC的配置项
3. **动态切换**: 通过配置或参数动态选择RTC类型
4. **环境隔离**: 开发、测试、生产环境使用不同的配置

## 1. 前端环境变量配置

### 1.1 .env 文件配置

**修改文件**: `ai_agents/playground/.env`

**修改前**:

```bash
# ai_agents/playground/.env
NEXT_PUBLIC_AGORA_APP_ID=your_agora_app_id
```

**修改后**:

```bash
# ai_agents/playground/.env
# 阿里云 RTC 配置
NEXT_PUBLIC_ALI_RTC_APP_ID=your_ali_rtc_app_id
NEXT_PUBLIC_ALI_RTC_APP_KEY=your_ali_rtc_app_key

# 保持向后兼容的Agora配置
NEXT_PUBLIC_AGORA_APP_ID=your_agora_app_id
NEXT_PUBLIC_AGORA_APP_CERTIFICATE=your_agora_app_certificate

# 默认 RTC 类型 (可选)
NEXT_PUBLIC_DEFAULT_RTC_TYPE=ali
```

### 1.2 .env.local 文件配置

**修改文件**: `ai_agents/playground/.env.local`

```bash
# ai_agents/playground/.env.local
# 阿里云 RTC 配置
NEXT_PUBLIC_ALI_RTC_APP_ID=your_ali_rtc_app_id
NEXT_PUBLIC_ALI_RTC_APP_KEY=your_ali_rtc_app_key

# 保持向后兼容的Agora配置
NEXT_PUBLIC_AGORA_APP_ID=your_agora_app_id
NEXT_PUBLIC_AGORA_APP_CERTIFICATE=your_agora_app_certificate

# 默认 RTC 类型
NEXT_PUBLIC_DEFAULT_RTC_TYPE=ali

# 开发环境配置
NEXT_PUBLIC_API_BASE_URL=http://localhost:8080
```

### 1.3 .env.production 文件配置

**修改文件**: `ai_agents/playground/.env.production`

```bash
# ai_agents/playground/.env.production
# 阿里云 RTC 配置
NEXT_PUBLIC_ALI_RTC_APP_ID=your_production_ali_rtc_app_id
NEXT_PUBLIC_ALI_RTC_APP_KEY=your_production_ali_rtc_app_key

# 默认 RTC 类型
NEXT_PUBLIC_DEFAULT_RTC_TYPE=ali

# 生产环境配置
NEXT_PUBLIC_API_BASE_URL=https://your-production-domain.com
```

## 2. 后端环境变量配置

### 2.1 application.yml 配置

**修改文件**: `ai_agents/addons/server/src/main/resources/application.yml`

**修改前**:

```yaml
# ai_agents/addons/server/src/main/resources/application.yml
agora:
  app:
    id: ${AGORA_APP_ID}
    certificate: ${AGORA_APP_CERTIFICATE}
```

**修改后**:

```yaml
# ai_agents/addons/server/src/main/resources/application.yml
agora:
  app:
    id: ${AGORA_APP_ID}
    certificate: ${AGORA_APP_CERTIFICATE}

ali:
  rtc:
    app:
      id: ${ALI_RTC_APP_ID}
      key: ${ALI_RTC_APP_KEY}

# 默认 RTC 类型
rtc:
  default-type: ${RTC_DEFAULT_TYPE:agora}
```

### 2.2 application-dev.yml 配置

**修改文件**: `ai_agents/addons/server/src/main/resources/application-dev.yml`

```yaml
# ai_agents/addons/server/src/main/resources/application-dev.yml
agora:
  app:
    id: ${AGORA_APP_ID:dev_agora_app_id}
    certificate: ${AGORA_APP_CERTIFICATE:dev_agora_certificate}

ali:
  rtc:
    app:
      id: ${ALI_RTC_APP_ID:dev_ali_rtc_app_id}
      key: ${ALI_RTC_APP_KEY:dev_ali_rtc_app_key}

rtc:
  default-type: ${RTC_DEFAULT_TYPE:ali}
```

### 2.3 application-prod.yml 配置

**修改文件**: `ai_agents/addons/server/src/main/resources/application-prod.yml`

```yaml
# ai_agents/addons/server/src/main/resources/application-prod.yml
agora:
  app:
    id: ${AGORA_APP_ID}
    certificate: ${AGORA_APP_CERTIFICATE}

ali:
  rtc:
    app:
      id: ${ALI_RTC_APP_ID}
      key: ${ALI_RTC_APP_KEY}

rtc:
  default-type: ${RTC_DEFAULT_TYPE:ali}
```

## 3. Docker 环境变量配置

### 3.1 docker-compose.yml 配置

**修改文件**: `ai_agents/addons/docker-compose.yml`

**修改前**:

```yaml
# ai_agents/addons/docker-compose.yml
services:
  ten-agent-deploy:
    environment:
      - AGORA_APP_ID=${AGORA_APP_ID}
      - AGORA_APP_CERTIFICATE=${AGORA_APP_CERTIFICATE}
```

**修改后**:

```yaml
# ai_agents/addons/docker-compose.yml
services:
  ten-agent-deploy:
    environment:
      # Agora 配置
      - AGORA_APP_ID=${AGORA_APP_ID}
      - AGORA_APP_CERTIFICATE=${AGORA_APP_CERTIFICATE}

      # 阿里云 RTC 配置
      - ALI_RTC_APP_ID=${ALI_RTC_APP_ID}
      - ALI_RTC_APP_KEY=${ALI_RTC_APP_KEY}

      # 默认 RTC 类型
      - RTC_DEFAULT_TYPE=${RTC_DEFAULT_TYPE:ali}
```

### 3.2 .env 文件配置

**修改文件**: `ai_agents/addons/.env`

**修改前**:

```bash
# ai_agents/addons/.env
AGORA_APP_ID=your_agora_app_id
AGORA_APP_CERTIFICATE=your_agora_app_certificate
```

**修改后**:

```bash
# ai_agents/addons/.env
# Agora 配置
AGORA_APP_ID=your_agora_app_id
AGORA_APP_CERTIFICATE=your_agora_app_certificate

# 阿里云 RTC 配置
ALI_RTC_APP_ID=your_ali_rtc_app_id
ALI_RTC_APP_KEY=your_ali_rtc_app_key

# 默认 RTC 类型
RTC_DEFAULT_TYPE=ali
```

## 4. 配置验证

### 4.1 前端配置验证

**验证文件**: `ai_agents/playground/src/config/rtc.ts`

```typescript
// ai_agents/playground/src/config/rtc.ts
export const rtcConfig = {
  // 阿里云 RTC 配置
  aliRtc: {
    appId: process.env.NEXT_PUBLIC_ALI_RTC_APP_ID || "",
    appKey: process.env.NEXT_PUBLIC_ALI_RTC_APP_KEY || "",
  },

  // 默认 RTC 类型
  defaultType:
    (process.env.NEXT_PUBLIC_DEFAULT_RTC_TYPE as "agora" | "ali") || "ali",

  // 验证配置
  validate() {
    if (!this.aliRtc.appId) {
      throw new Error("NEXT_PUBLIC_ALI_RTC_APP_ID 未配置");
    }
    if (!this.aliRtc.appKey) {
      throw new Error("NEXT_PUBLIC_ALI_RTC_APP_KEY 未配置");
    }
    return true;
  },
};
```

### 4.2 后端配置验证

**验证文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/config/RtcConfig.java`

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/config/RtcConfig.java
@Component
public class RtcConfig {

    @Value("${ali.rtc.app.id}")
    private String aliRtcAppId;

    @Value("${ali.rtc.app.key}")
    private String aliRtcAppKey;

    @Value("${rtc.default-type:agora}")
    private String defaultRtcType;

    @PostConstruct
    public void validateConfig() {
        if (aliRtcAppId == null || aliRtcAppId.trim().isEmpty()) {
            throw new IllegalStateException("ALI_RTC_APP_ID 未配置");
        }
        if (aliRtcAppKey == null || aliRtcAppKey.trim().isEmpty()) {
            throw new IllegalStateException("ALI_RTC_APP_KEY 未配置");
        }
    }

    public String getAliRtcAppId() {
        return aliRtcAppId;
    }

    public String getAliRtcAppKey() {
        return aliRtcAppKey;
    }

    public String getDefaultRtcType() {
        return defaultRtcType;
    }
}
```

## 5. 配置迁移步骤

### 5.1 前端配置迁移

1. **备份现有配置**:

```bash
cp ai_agents/playground/.env ai_agents/playground/.env.backup
```

2. **更新环境变量**:

```bash
# 添加阿里云 RTC 配置
echo "NEXT_PUBLIC_ALI_RTC_APP_ID=your_ali_rtc_app_id" >> ai_agents/playground/.env
echo "NEXT_PUBLIC_ALI_RTC_APP_KEY=your_ali_rtc_app_key" >> ai_agents/playground/.env
echo "NEXT_PUBLIC_DEFAULT_RTC_TYPE=ali" >> ai_agents/playground/.env
```

3. **验证配置**:

```bash
cd ai_agents/playground
npm run build
```

### 5.2 后端配置迁移

1. **备份现有配置**:

```bash
cp ai_agents/addons/server/src/main/resources/application.yml ai_agents/addons/server/src/main/resources/application.yml.backup
```

2. **更新配置文件**:

```bash
# 添加阿里云 RTC 配置到 application.yml
echo "ali:" >> ai_agents/addons/server/src/main/resources/application.yml
echo "  rtc:" >> ai_agents/addons/server/src/main/resources/application.yml
echo "    app:" >> ai_agents/addons/server/src/main/resources/application.yml
echo "      id: \${ALI_RTC_APP_ID}" >> ai_agents/addons/server/src/main/resources/application.yml
echo "      key: \${ALI_RTC_APP_KEY}" >> ai_agents/addons/server/src/main/resources/application.yml
```

3. **验证配置**:

```bash
cd ai_agents/addons/server
mvn clean compile
```

## 6. 配置错误排查

### 6.1 常见配置错误

1. **环境变量未设置**:

```bash
# 检查环境变量
echo $NEXT_PUBLIC_ALI_RTC_APP_ID
echo $ALI_RTC_APP_ID
```

2. **配置文件格式错误**:

```bash
# 验证 YAML 格式
yaml lint ai_agents/addons/server/src/main/resources/application.yml
```

3. **权限问题**:

```bash
# 检查文件权限
ls -la ai_agents/playground/.env
ls -la ai_agents/addons/.env
```

### 6.2 配置验证命令

```bash
# 前端配置验证
cd ai_agents/playground
node -e "console.log('ALI_RTC_APP_ID:', process.env.NEXT_PUBLIC_ALI_RTC_APP_ID)"

# 后端配置验证
cd ai_agents/addons/server
mvn spring-boot:run -Dspring-boot.run.arguments="--debug"
```

## 7. 关键配置要点

### 7.1 必须配置的环境变量

**前端**:

- `NEXT_PUBLIC_ALI_RTC_APP_ID`
- `NEXT_PUBLIC_ALI_RTC_APP_KEY`

**后端**:

- `ALI_RTC_APP_ID`
- `ALI_RTC_APP_KEY`

### 7.2 可选配置

- `NEXT_PUBLIC_DEFAULT_RTC_TYPE`
- `RTC_DEFAULT_TYPE`

### 7.3 配置优先级

1. 环境变量
2. .env 文件
3. 默认值

### 7.4 安全注意事项

1. **不要提交敏感信息**: 确保 .env 文件在 .gitignore 中
2. **使用环境变量**: 生产环境使用环境变量而不是文件
3. **定期轮换**: 定期更新 App Key
4. **权限控制**: 确保只有必要的人员能访问配置
