# 代码重构示例 - 2: 后端重构

## 重构前的 TokenService

```java
// 重构前: TokenService.java
import io.agora.rtc.RtcTokenBuilder2;

@Service
public class TokenService {

    @Value("${agora.app.id}")
    private String appId;

    @Value("${agora.app.certificate}")
    private String appCertificate;

    public String generateToken(String channelName, String uid) {
        return RtcTokenBuilder2.buildTokenWithUid(
            appId,
            appCertificate,
            channelName,
            uid,
            RtcTokenBuilder2.Role.Role_Publisher,
            3600
        );
    }
}
```

## 重构后的 TokenService

```java
// 重构后: TokenService.java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class TokenService {

    @Autowired
    private AgoraTokenService agoraTokenService;

    @Autowired
    private AliTokenService aliTokenService;

    public String generateToken(String channel, String uid, String rtcType) {
        if ("ali".equals(rtcType)) {
            return aliTokenService.generateToken(channel, uid);
        } else {
            return agoraTokenService.generateToken(channel, uid);
        }
    }

    // 保持向后兼容
    public String generateToken(String channel, String uid) {
        return generateToken(channel, uid, "agora");
    }
}
```

## 新增的 Token 服务

```java
// AgoraTokenService.java
@Service
public class AgoraTokenService {

    @Value("${agora.app.id}")
    private String appId;

    @Value("${agora.app.certificate}")
    private String appCertificate;

    public String generateToken(String channelName, String uid) {
        return RtcTokenBuilder2.buildTokenWithUid(
            appId,
            appCertificate,
            channelName,
            uid,
            RtcTokenBuilder2.Role.Role_Publisher,
            3600
        );
    }
}

// AliTokenService.java
@Service
public class AliTokenService {

    @Value("${ali.app.id}")
    private String appId;

    @Value("${ali.app.key}")
    private String appKey;

    public String generateToken(String channelId, String userId) {
        return generateAliToken(appId, appKey, channelId, userId, 3600);
    }

    private String generateAliToken(String appId, String appKey,
                                  String channelId, String userId, int expireTime) {
        // 实现阿里云 Token 生成逻辑
        return "ali_token_placeholder";
    }
}
```

## 重构前后的对比

### 主要变化

1. **服务分离**: 将 Agora 和阿里云 Token 生成逻辑分离
2. **策略模式**: 根据 RTC 类型选择对应的 Token 服务
3. **向后兼容**: 保持原有的方法签名不变
4. **配置驱动**: 通过配置文件管理不同 RTC 服务的参数

### 优势

- **可扩展性**: 可以轻松添加新的 RTC 服务
- **可维护性**: 每个服务职责单一

- **向后兼容**: 现有代码无需修改
