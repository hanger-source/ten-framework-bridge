# 迁移实施总结 - 后端部分

## 后端核心文件

**需要修改的文件**:

- `ai_agents/addons/server/src/main/java/.../TokenService.java`
- `ai_agents/addons/server/src/main/java/.../TokenController.java`

**配置文件**:

- `ai_agents/addons/server/src/main/resources/application.yml`

## 后端迁移步骤

### 步骤1: 后端Token服务迁移

1. **重构Token服务**:

```java
// TokenService.java
@Service
public class TokenService {
    @Value("${ali.app.id}")
    private String appId;

    @Value("${ali.app.key}")
    private String appKey;

    public String generateToken(String channel, String uid) {
        return generateAliToken(appId, appKey, channel, uid, 3600);
    }

    private String generateAliToken(String appId, String appKey,
                                  String channelId, String userId, int expireTime) {
        try {
            long timestamp = System.currentTimeMillis() / 1000;
            long expireTimestamp = timestamp + expireTime;

            // 构建Token字符串
            String tokenString = String.format(
                "appId=%s&channelId=%s&userId=%s&timestamp=%d&expire=%d",
                appId, channelId, userId, timestamp, expireTimestamp
            );

            // 使用HMAC-SHA256签名
            Mac mac = Mac.getInstance("HmacSHA256");
            SecretKeySpec secretKeySpec = new SecretKeySpec(appKey.getBytes(), "HmacSHA256");
            mac.init(secretKeySpec);
            byte[] signature = mac.doFinal(tokenString.getBytes());

            // Base64编码
            String signatureBase64 = Base64.getEncoder().encodeToString(signature);

            // 构建最终Token
            return String.format("%s&signature=%s", tokenString, signatureBase64);

        } catch (Exception e) {
            throw new RuntimeException("Failed to generate Ali RTC token", e);
        }
    }
}
```

2. **更新API接口**:

```java
// TokenController.java
@RestController
@RequestMapping("/api/token")
public class TokenController {

    @Autowired
    private TokenService tokenService;

    @PostMapping("/generate")
    public ResponseEntity<String> generateToken(@RequestBody TokenRequest request) {
        String token = tokenService.generateToken(request.getChannel(), request.getUid());
        return ResponseEntity.ok(token);
    }
}
```

### 步骤2: 后端配置迁移

1. **更新application.yml**:

```yaml
# application.yml
ali:
  app:
    id: ${ALI_APP_ID}
    key: ${ALI_APP_KEY}
```

2. **更新环境变量**:

```bash
# 环境变量
export ALI_APP_ID="your_ali_app_id"
export ALI_APP_KEY="your_ali_app_key"
```

### 步骤3: 后端请求对象更新

```java
// TokenRequest.java
public class TokenRequest {
    private String channel;
    private String uid;

    // getters and setters
    public String getChannel() { return channel; }
    public void setChannel(String channel) { this.channel = channel; }

    public String getUid() { return uid; }
    public void setUid(String uid) { this.uid = uid; }
}
```

### 步骤4: 后端错误处理

```java
// TokenController.java
@PostMapping("/generate")
public ResponseEntity<String> generateToken(@RequestBody TokenRequest request) {
    try {
        String token = tokenService.generateToken(request.getChannel(), request.getUid());
        return ResponseEntity.ok(token);
    } catch (Exception e) {
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body("Failed to generate Ali RTC token: " + e.getMessage());
    }
}
```

## 关键差异总结

### 1. Token生成算法

- **Agora**: 使用RtcTokenBuilder2，需要appId和appCertificate
- **阿里云**: 使用HMAC-SHA256签名，需要appId和appKey

### 2. Token结构

- **Agora**: 单一Token字符串
- **阿里云**: 包含参数和签名的复合字符串

### 3. 配置参数

- **Agora**: appId + appCertificate
- **阿里云**: appId + appKey

### 4. 错误处理

- **Agora**: "Failed to generate Agora token"
- **阿里云**: "Failed to generate Ali RTC token"
