# 核心迁移点分析 - 后端部分

## 1. 重新理解系统架构

### 1.1 实际的数据流分析

```
用户操作 → 前端 (playground)
  ↓ 调用 /api/token/generate
Java Server (addons/server) → 生成 token
  ↓ 返回 token
前端 (playground) → 使用 token 连接 RTC
  ↓ 音视频通信
RTC 服务 (阿里云)
```

### 1.2 完整的系统架构

**重要发现**: 通过深入分析，发现系统需要将Agora RTC完全替换为阿里云RTC：

```
前端 (playground)
    ↓ HTTP请求
中间件 (middleware.tsx)
    ↓ URL重写
Java后端 (addons/server)
    ↓ 启动Worker
Go Worker进程 (agents/bin/start)
    ↓ 加载扩展
RTC扩展 (ali_rtc/ali_rtm)
    ↓ 连接服务
RTC服务 (阿里云)
```

**关键组件**:

1. **前端层**: Next.js应用，负责UI和用户交互
2. **中间件层**: 处理API请求路由和重写
3. **后端层**: Java Spring Boot应用，负责Token生成和Worker管理
4. **Worker层**: Go进程，负责具体的RTC连接和消息处理
5. **扩展层**: 各种扩展模块，包括RTC、RTM、LLM等
6. **服务层**: 外部RTC服务提供商

**数据流向**:

1. **Token生成**: 前端 → 中间件 → Java后端 → 返回Token
2. **Worker启动**: Java后端 → 启动Go Worker进程
3. **RTC连接**: Go Worker → 加载RTC扩展 → 连接RTC服务
4. **消息传递**: RTC扩展 → 处理音视频和消息 → 返回给前端

### 1.3 Worker 的真实作用

- Worker 只是接收 `properties` 参数
- `properties` 中包含 RTC 相关信息
- Worker 本身不直接处理 RTC 连接
- Worker 只是被传递配置，不是核心迁移点

## 2. 后端核心迁移点

### 2.1 后端 Token 生成服务

**位置**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/service/TokenService.java`

**核心功能**:

- 生成 Agora RTC Token
- 需要替换为阿里云 RTC Token 生成

**关键差异**:

- Agora: 使用 `RtcTokenBuilder2`，需要 `appId`, `appCertificate`
- 阿里云: 使用 `@dingrtc/token-generator`，需要 `appId`, `appKey`

**具体迁移点**:

- Token生成器: `RtcTokenBuilder2.buildTokenWithUid()` → 阿里云Token生成器
- 参数配置: `appCertificate` → `appKey`
- Token格式: 需要保持兼容性，确保前端能正确解析

### 2.2 后端 API 控制器

**位置**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/controller/TokenController.java`

**核心功能**:

- 提供 `/api/token/generate` 接口
- 需要替换为阿里云 Token 生成

**迁移要点**:

- 接口参数: 移除 `rtcType` 参数
- 错误处理: 针对阿里云 RTC 的错误处理
- 响应格式: 保持与现有接口的兼容性

### 2.3 后端配置文件

**位置**: `ai_agents/addons/server/src/main/resources/application.yml`

**核心功能**:

- 配置 Agora RTC 参数
- 需要替换为阿里云 RTC 配置

**迁移要点**:

- 移除阿里云配置项: `agora.app.id`, `agora.app.certificate`
- 新增阿里云配置项: `ali.app.id`, `ali.app.key`
- 环境变量支持: 支持从环境变量读取配置
