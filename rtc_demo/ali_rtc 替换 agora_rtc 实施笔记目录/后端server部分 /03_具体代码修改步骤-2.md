# 具体代码修改步骤 - 2: 后端Token服务完全替换

## 参考文档

- [阿里云RTC Token生成文档](https://help.aliyun.com/document_detail/2864109.html)
- [阿里云RTC Token验证文档](https://help.aliyun.com/document_detail/159037.html)

## 1. 删除Agora依赖

**修改文件**: `ai_agents/addons/server/pom.xml`

```xml
<!-- 删除Agora依赖 -->
<!--
<dependency>
    <groupId>io.agora.rtc</groupId>
    <artifactId>voice-sdk</artifactId>
    <version>4.2.2</version>
</dependency>
-->

<!-- 添加阿里云RTC依赖 -->
<dependency>
    <groupId>io.netty</groupId>
    <artifactId>netty-buffer</artifactId>
    <version>4.1.86.Final</version>
</dependency>
```

## 2. 完全替换TokenService

**修改文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/service/TokenService.java`

```java
@Service
public class TokenService {
    @Value("${ali.app.id}")
    private String appId;

    @Value("${ali.app.key}")
    private String appKey;

    @Autowired
    private AliRtcTokenGenerator tokenGenerator;

    public String generateToken(String channelId, String userId) {
        try {
            return tokenGenerator.generateDefaultToken(appId, appKey, channelId, userId);
        } catch (Exception e) {
            throw new RuntimeException("Failed to generate Ali RTC token", e);
        }
    }
}
```

## 3. 更新配置文件

**修改文件**: `ai_agents/addons/server/src/main/resources/application.yml`

```yaml
# 删除Agora配置
# agora:
#   app:
#     id: ${AGORA_APP_ID}
#     certificate: ${AGORA_APP_CERTIFICATE}

# 只保留阿里云RTC配置
ali:
  app:
    id: ${ALI_APP_ID}
    key: ${ALI_APP_KEY}
```

## 4. 更新环境变量

**修改文件**: `ai_agents/addons/server/.env`

```bash
# 删除Agora环境变量
# export AGORA_APP_ID="your_agora_app_id"
# export AGORA_APP_CERTIFICATE="your_agora_app_certificate"

# 只保留阿里云环境变量
export ALI_APP_ID="your_ali_app_id"
export ALI_APP_KEY="your_ali_app_key"
```

## 5. 详细实现

完整的阿里云RTC Token实现请参考：

- [09*阿里云RTC_Token*官方实现补充.md](./09_阿里云RTC_Token_官方实现补充.md)

## 6. 验证步骤

1. 删除Agora相关依赖
2. 编译项目
3. 启动服务
4. 测试Token生成接口
5. 验证Token有效性
