# 迁移细节补充

## 1. 核心发现总结

### 1.1 系统架构重新理解

通过深入分析，发现系统实际上是**双RTC支持架构**，而不是简单的替换：

```
前端 (playground) → 中间件 → Java后端 → Go Worker → RTC扩展 → RTC服务
```

**关键组件**:

- **前端层**: Next.js应用，负责UI和用户交互
- **中间件层**: 处理API请求路由和重写
- **后端层**: Java Spring Boot应用，负责Token生成和Worker管理
- **Worker层**: Go进程，负责具体的RTC连接和消息处理
- **扩展层**: 各种扩展模块，包括RTC、RTM、LLM等
- **服务层**: 外部RTC服务提供商

### 1.2 真正的核心迁移点

1. **后端Token服务**: `TokenService.java` - 需要支持阿里云Token生成
2. **前端RTC客户端**: `rtc.ts` - 需要迁移为阿里云RTC SDK
3. **环境配置**: 需要支持双RTC配置
4. **类型定义**: 需要更新为阿里云RTC类型

## 2. 具体代码修改细节

### 2.1 前端RTC客户端迁移

**文件**: `ai_agents/playground/src/manager/rtc/rtc.ts`

#### 2.1.1 导入语句修改

```typescript
// 修改前
import AgoraRTC, {
  IAgoraRTCClient,
  IMicrophoneAudioTrack,
  IRemoteAudioTrack,
  UID,
} from "agora-rtc-sdk-ng";

// 修改后
import DingRTC, {
  DingRTCClient,
  MicrophoneAudioTrack,
  RemoteAudioTrack,
  UID,
} from "dingrtc";
```

#### 2.1.2 客户端创建修改

```typescript
// 修改前
export class RtcManager extends AGEventEmitter<RtcEvents> {
  client: IAgoraRTCClient;

  constructor() {
    this.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
  }
}

// 修改后
export class RtcManager extends AGEventEmitter<RtcEvents> {
  client: DingRTCClient;

  constructor() {
    this.client = DingRTC.createClient();
  }
}
```

#### 2.1.3 轨道创建修改

```typescript
// 修改前
async createMicrophoneAudioTrack() {
  const audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
  this.localTracks.audioTrack = audioTrack;
}

async createCameraTracks() {
  const videoTrack = await AgoraRTC.createCameraVideoTrack();
  this.localTracks.videoTrack = videoTrack;
}

async createScreenShareTrack() {
  const screenTrack = await AgoraRTC.createScreenVideoTrack({
    encoderConfig: { width: 1200, height: 800, frameRate: 5 }
  }, "disable");
  this.localTracks.screenTrack = screenTrack;
}

// 修改后
async createMicrophoneAudioTrack() {
  const audioTrack = await DingRTC.createMicrophoneAudioTrack();
  this.localTracks.audioTrack = audioTrack;
}

async createCameraTracks() {
  const videoTrack = await DingRTC.createCameraVideoTrack();
  this.localTracks.videoTrack = videoTrack;
}

async createScreenShareTrack() {
  // 重要差异：阿里云返回数组
  const screenTracks = await DingRTC.createScreenVideoTrack({
    dimension: { width: 1200, height: 800, frameRate: 5 }
  });
  this.localTracks.screenTrack = screenTracks[0];
}
```

#### 2.1.4 房间连接修改

```typescript
// 修改前
await this.client?.join(appId, channel, finalToken, userId);

// 修改后
await this.client?.join({
  appId: appId,
  channel: channel,
  uid: userId,
  userName: `user_${userId}`, // 阿里云需要userName参数
  token: finalToken,
});
```

#### 2.1.5 事件监听修改

```typescript
// 修改前
private _listenRtcEvents() {
  this.client.on("user-published", async (user, mediaType) => {
    await this.client.subscribe(user, mediaType);
    this.emit("remoteUserChanged", {
      userId: user.uid, // Agora使用uid
      audioTrack: user.audioTrack,
      videoTrack: user.videoTrack,
    });
  });
}

// 修改后
private _listenRtcEvents() {
  this.client.on("user-published", async (user, mediaType) => {
    await this.client.subscribe(user.userId, mediaType); // 阿里云使用userId
    this.emit("remoteUserChanged", {
      userId: user.userId, // 阿里云使用userId
      audioTrack: user.audioTrack,
      videoTrack: user.videoTrack,
    });
  });
}
```

### 2.2 类型定义更新

**文件**: `ai_agents/playground/src/manager/rtc/types.ts`

```typescript
// 修改前
import {
  UID,
  IAgoraRTCRemoteUser,
  IAgoraRTCClient,
  ICameraVideoTrack,
  IMicrophoneAudioTrack,
  NetworkQuality,
  ILocalVideoTrack,
} from "agora-rtc-sdk-ng";

export interface IUserTracks {
  videoTrack?: ICameraVideoTrack;
  screenTrack?: ILocalVideoTrack;
  audioTrack?: IMicrophoneAudioTrack;
}

// 修改后
import {
  UID,
  RemoteUser,
  DingRTCClient,
  CameraVideoTrack,
  MicrophoneAudioTrack,
  NetworkQuality,
  LocalVideoTrack,
} from "dingrtc";

export interface IUserTracks {
  videoTrack?: CameraVideoTrack;
  screenTrack?: LocalVideoTrack;
  audioTrack?: MicrophoneAudioTrack;
}
```

### 2.3 后端Token服务迁移

**文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/service/TokenService.java`

#### 2.3.1 创建阿里云Token服务

```java
// 新增文件: AliTokenService.java
@Service
public class AliTokenService {

    @Value("${ali.rtc.app.id}")
    private String appId;

    @Value("${ali.rtc.app.key}")
    private String appKey;

    public String generateToken(String channelId, String userId) {
        try {
            long timestamp = System.currentTimeMillis() / 1000;
            long expireTime = timestamp + 3600; // 1小时过期

            // 构建签名字符串
            String signString = String.format("%s:%s:%s:%d", appId, channelId, userId, expireTime);

            // 使用HMAC-SHA256签名
            String signature = generateHMACSHA256(signString, appKey);

            // 构建Token
            String token = String.format("%s:%s:%s:%d:%s", appId, channelId, userId, expireTime, signature);

            return Base64.getEncoder().encodeToString(token.getBytes());

        } catch (Exception e) {
            throw new RuntimeException("Failed to generate Ali RTC token", e);
        }
    }

    private String generateHMACSHA256(String data, String key) throws Exception {
        javax.crypto.Mac mac = javax.crypto.Mac.getInstance("HmacSHA256");
        javax.crypto.spec.SecretKeySpec secretKeySpec = new javax.crypto.spec.SecretKeySpec(key.getBytes(), "HmacSHA256");
        mac.init(secretKeySpec);
        byte[] hash = mac.doFinal(data.getBytes());
        return Base64.getEncoder().encodeToString(hash);
    }
}
```

#### 2.3.2 修改主Token服务

```java
// 修改TokenService.java
@Service
public class TokenService {

    @Autowired
    private AgoraTokenService agoraTokenService;

    @Autowired
    private AliTokenService aliTokenService;

    public String generateToken(String channel, String uid, String rtcType) {
        if ("ali".equals(rtcType)) {
            return aliTokenService.generateToken(channel, uid);
        } else {
            return agoraTokenService.generateToken(channel, uid);
        }
    }

    // 保持向后兼容
    public String generateToken(String channel, String uid) {
        return generateToken(channel, uid, "agora");
    }
}
```

### 2.4 环境配置更新

#### 2.4.1 前端环境变量

**文件**: `ai_agents/playground/.env`

```bash
# 阿里云 RTC 配置
NEXT_PUBLIC_ALI_RTC_APP_ID=your_ali_rtc_app_id
NEXT_PUBLIC_ALI_RTC_APP_KEY=your_ali_rtc_app_key

# 保持向后兼容的Agora配置
NEXT_PUBLIC_AGORA_APP_ID=your_agora_app_id
NEXT_PUBLIC_AGORA_APP_CERTIFICATE=your_agora_app_certificate

# 默认 RTC 类型
NEXT_PUBLIC_DEFAULT_RTC_TYPE=ali
```

#### 2.4.2 后端环境变量

**文件**: `ai_agents/addons/server/src/main/resources/application.yml`

```yaml
agora:
  app:
    id: ${AGORA_APP_ID}
    certificate: ${AGORA_APP_CERTIFICATE}

ali:
  rtc:
    app:
      id: ${ALI_RTC_APP_ID}
      key: ${ALI_RTC_APP_KEY}

# 默认 RTC 类型
rtc:
  default-type: ${RTC_DEFAULT_TYPE:agora}
```

## 3. 关键差异总结

### 3.1 SDK差异

| 项目       | Agora RTC                              | 阿里云RTC                                             |
| ---------- | -------------------------------------- | ----------------------------------------------------- |
| SDK包      | `agora-rtc-sdk-ng`                     | `dingrtc`                                             |
| 客户端创建 | `AgoraRTC.createClient({mode, codec})` | `DingRTC.createClient()`                              |
| 轨道创建   | `AgoraRTC.createXXXTrack()`            | `DingRTC.createXXXTrack()`                            |
| 房间连接   | `client.join(token, channel, uid)`     | `client.join({appId, token, uid, channel, userName})` |
| 用户标识   | `user.uid`                             | `user.userId`                                         |

### 3.2 配置差异

| 项目       | Agora RTC             | 阿里云RTC         |
| ---------- | --------------------- | ----------------- |
| 必需参数   | mode, codec           | 无                |
| Token生成  | appId, appCertificate | appId, appKey     |
| 用户标识   | uid                   | userId + userName |
| 配置复杂度 | 中等                  | 简单              |

### 3.3 事件系统差异

| 项目     | Agora RTC                           | 阿里云RTC                             |
| -------- | ----------------------------------- | ------------------------------------- |
| 用户加入 | `user.uid`                          | `user.userId`                         |
| 订阅方法 | `client.subscribe(user, mediaType)` | `client.subscribe(userId, mediaType)` |
| 错误码   | `OPERATION_ABORTED`                 | `OPERATION_CANCELLED`                 |

## 4. 迁移验证步骤

### 4.1 前端验证

1. **SDK安装验证**:

   ```bash
   npm install dingrtc
   ```

2. **客户端创建验证**:

   ```typescript
   const client = DingRTC.createClient();
   console.log("阿里云RTC客户端创建成功");
   ```

3. **轨道创建验证**:

   ```typescript
   const audioTrack = await DingRTC.createMicrophoneAudioTrack();
   const videoTrack = await DingRTC.createCameraVideoTrack();
   console.log("轨道创建成功");
   ```

4. **房间连接验证**:
   ```typescript
   await client.join({
     appId: "test_app_id",
     token: "test_token",
     uid: "test_user_id",
     channel: "test_channel",
     userName: "test_user_name",
   });
   console.log("房间连接成功");
   ```

### 4.2 后端验证

1. **Token生成验证**:

   ```java
   String token = aliTokenService.generateToken("test_channel", "test_user_id");
   System.out.println("阿里云Token生成成功: " + token);
   ```

2. **配置加载验证**:
   ```java
   @Value("${ali.rtc.app.id}")
   private String appId;
   System.out.println("阿里云AppId加载成功: " + appId);
   ```

### 4.3 集成测试

1. **完整流程测试**:
   - 前端请求Token
   - 后端生成阿里云Token
   - 前端使用Token连接阿里云RTC
   - 验证音视频通信

2. **兼容性测试**:
   - 验证Agora RTC功能仍然正常
   - 验证阿里云RTC功能正常
   - 验证动态切换功能

## 5. 注意事项

### 5.1 重要发现

1. **双RTC支持**: 系统需要同时支持Agora和阿里云RTC，而不是完全替换
2. **向后兼容**: 现有的Agora RTC配置和功能需要保留
3. **动态切换**: 通过配置或参数可以动态选择RTC类型
4. **环境隔离**: 不同环境使用不同的RTC配置

### 5.2 迁移风险

1. **SDK兼容性**: 阿里云RTC SDK可能与现有代码不完全兼容
2. **Token格式**: 阿里云Token格式与Agora不同，需要验证
3. **事件系统**: 事件名称和参数可能有差异
4. **错误处理**: 错误码和错误信息需要适配

### 5.3 测试建议

1. **单元测试**: 为每个迁移的组件编写单元测试
2. **集成测试**: 测试完整的RTC通信流程
3. **兼容性测试**: 验证Agora RTC功能不受影响
4. **性能测试**: 验证阿里云RTC的性能表现

## 6. 下一步计划

1. **实施前端迁移**: 按照上述步骤修改前端代码
2. **实施后端迁移**: 创建阿里云Token服务
3. **配置环境变量**: 设置阿里云RTC配置
4. **进行测试验证**: 验证迁移的正确性
5. **部署和监控**: 部署到测试环境并监控运行状态
