# 迁移实施总结 - 1: 完整迁移步骤

## 迁移概述

基于对现有代码的深入分析，我们已经完成了从Agora RTC到阿里云RTC的完整迁移规划。迁移分为三个核心部分：

1. **前端RTC客户端迁移** - 核心RTC功能
2. **后端Token服务迁移** - Token生成服务
3. **前端Token获取和配置迁移** - 配置和请求

## 迁移文件清单

### 1. 前端核心文件

**需要修改的文件**:

- `ai_agents/playground/src/components/RTCManager.ts`
- `ai_agents/playground/src/hooks/useRTC.ts`
- `ai_agents/playground/src/common/request.ts`
- `ai_agents/playground/src/config/rtc.ts`
- `ai_agents/playground/src/config/env.ts`

**需要新增的文件**:

- `ai_agents/playground/src/types/rtc.ts` (类型定义)
- `ai_agents/playground/src/utils/rtcAdapter.ts` (适配器)

### 2. 后端核心文件

**需要修改的文件**:

- `ai_agents/addons/server/src/main/java/.../TokenService.java`
- `ai_agents/addons/server/src/main/java/.../TokenController.java`

**需要新增的文件**:

- `ai_agents/addons/server/src/main/java/.../AgoraTokenService.java`
- `ai_agents/addons/server/src/main/java/.../AliTokenService.java`

### 3. 配置文件

**需要修改的文件**:

- `ai_agents/addons/server/src/main/resources/application.yml`
- `ai_agents/playground/.env`

## 迁移步骤详解

### 步骤1: 后端Token服务迁移

1. **创建阿里云Token服务**:

```java
// AliTokenService.java
@Service
public class AliTokenService {
    @Value("${ali.app.id}")
    private String appId;

    @Value("${ali.app.key}")
    private String appKey;

    public String generateToken(String channelId, String userId) {
        return generateAliToken(appId, appKey, channelId, userId, 3600);
    }
}
```

2. **重构主Token服务**:

```java
// TokenService.java
@Service
public class TokenService {
    @Autowired
    private AgoraTokenService agoraTokenService;

    @Autowired
    private AliTokenService aliTokenService;

    public String generateToken(String channel, String uid, String rtcType) {
        if ("ali".equals(rtcType)) {
            return aliTokenService.generateToken(channel, uid);
        } else {
            return agoraTokenService.generateToken(channel, uid);
        }
    }
}
```

3. **更新API接口**:

```java
// TokenController.java
@PostMapping("/generate")
public ResponseEntity<String> generateToken(@RequestBody TokenRequest request) {
    String rtcType = request.getRtcType() != null ? request.getRtcType() : "agora";
    String token = tokenService.generateToken(request.getChannel(), request.getUid(), rtcType);
    return ResponseEntity.ok(token);
}
```

### 步骤2: 前端RTC客户端迁移

1. **更新RTC管理器**:

```typescript
// RTCManager.ts
export class RTCManager {
  private client: IAgoraRTCClient | DingRTCClient;
  private rtcType: "agora" | "ali";

  constructor(rtcType: "agora" | "ali" = "agora") {
    this.rtcType = rtcType;

    if (rtcType === "ali") {
      this.client = DingRTC.createClient();
    } else {
      this.client = AgoraRTC.createClient({
        mode: "rtc",
        codec: "vp8",
      });
    }
  }
}
```

2. **更新Token请求**:

```typescript
// request.ts
export const requestToken = async (
  channel: string,
  uid: string,
  rtcType: "agora" | "ali" = "agora"
): Promise<string> => {
  const response = await fetch("/api/token/generate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ channel, uid, rtcType }),
  });
  return response.text();
};
```

3. **更新RTC Hook**:

```typescript
// useRTC.ts
export const useRTC = (rtcType: "agora" | "ali" = "agora") => {
  const [client, setClient] = useState<IAgoraRTCClient | DingRTCClient | null>(
    null
  );

  const joinChannel = useCallback(
    async (channel: string, uid: string) => {
      let rtcClient;

      if (rtcType === "ali") {
        rtcClient = DingRTC.createClient();
      } else {
        rtcClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
      }

      const token = await requestToken(channel, uid, rtcType);
      await rtcClient.join(token, channel, uid);
      setClient(rtcClient);
    },
    [rtcType]
  );

  return { joinChannel, leaveChannel: () => client?.leave() };
};
```

### 步骤3: 配置和环境变量迁移

1. **更新环境变量**:

```bash
# .env
REACT_APP_AGORA_APP_ID=your_agora_app_id
REACT_APP_ALI_APP_ID=your_ali_app_id
REACT_APP_DEFAULT_RTC_TYPE=agora
```

2. **更新应用配置**:

```yaml
# application.yml
agora:
  app:
    id: ${AGORA_APP_ID}
    certificate: ${AGORA_APP_CERTIFICATE}

ali:
  app:
    id: ${ALI_APP_ID}
    key: ${ALI_APP_KEY}
```

## 关键差异对比

### 1. 客户端创建

| 项目     | Agora RTC                       | 阿里云RTC                |
| -------- | ------------------------------- | ------------------------ |
| 创建方式 | `AgoraRTC.createClient(config)` | `DingRTC.createClient()` |
| 配置参数 | 需要mode和codec                 | 无需配置参数             |
| 复杂度   | 中等                            | 简单                     |

### 2. Token生成

| 项目 | Agora RTC              | 阿里云RTC             |
| ---- | ---------------------- | --------------------- |
| 算法 | RtcTokenBuilder2       | HMAC-SHA256           |
| 参数 | appId + appCertificate | appId + appKey        |
| 结构 | 单一Token字符串        | 参数+签名的复合字符串 |

### 3. 轨道创建

| 项目     | Agora RTC                               | 阿里云RTC                             |
| -------- | --------------------------------------- | ------------------------------------- |
| 音频轨道 | `AgoraRTC.createMicrophoneAudioTrack()` | `client.createMicrophoneAudioTrack()` |
| 视频轨道 | `AgoraRTC.createCameraVideoTrack()`     | `client.createCameraVideoTrack()`     |
| 配置方式 | 静态方法                                | 实例方法                              |

### 4. 用户标识

| 项目     | Agora RTC  | 阿里云RTC     |
| -------- | ---------- | ------------- |
| 字段名   | `uid`      | `userId`      |
| 事件参数 | `user.uid` | `user.userId` |

## 迁移验证清单

### 1. 后端验证

- [ ] Token服务支持双RTC类型
- [ ] API接口支持rtcType参数
- [ ] 配置文件包含阿里云参数
- [ ] 错误处理包含RTC类型标识

### 2. 前端验证

- [ ] RTC客户端支持动态创建
- [ ] Token请求支持rtcType参数
- [ ] 环境变量配置完整
- [ ] 错误处理包含RTC类型标识

### 3. 功能验证

- [ ] Agora RTC功能正常
- [ ] 阿里云RTC功能正常
- [ ] 动态切换功能正常
- [ ] 向后兼容性正常

## 迁移优势

### 1. 向后兼容

- 保持原有Agora RTC功能不变
- 新增rtcType参数支持动态切换
- 默认使用Agora RTC

### 2. 可扩展性

- 支持多种RTC服务
- 易于添加新的RTC提供商
- 配置驱动的架构

### 3. 可维护性

- 清晰的代码结构
- 分离的职责
- 统一的错误处理
