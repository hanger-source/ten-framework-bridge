# 具体代码修改步骤 - 2: 后端Token服务和RTM管理器修改

## 1. TokenService.java 修改

### 1.1 创建阿里云Token服务

**新增文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/service/AliTokenService.java`

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/service/AliTokenService.java
package com.agora.tenframework.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Base64;
import java.util.Date;

@Service
public class AliTokenService {

    @Value("${ali.rtc.app.id}")
    private String appId;

    @Value("${ali.rtc.app.key}")
    private String appKey;

    public String generateToken(String channelId, String userId) {
        try {
            // 阿里云RTC Token生成逻辑
            long timestamp = System.currentTimeMillis() / 1000;
            long expireTime = timestamp + 3600; // 1小时过期

            // 构建签名字符串
            String signString = String.format("%s:%s:%s:%d", appId, channelId, userId, expireTime);

            // 使用HMAC-SHA256签名
            String signature = generateHMACSHA256(signString, appKey);

            // 构建Token
            String token = String.format("%s:%s:%s:%d:%s", appId, channelId, userId, expireTime, signature);

            return Base64.getEncoder().encodeToString(token.getBytes());

        } catch (Exception e) {
            throw new RuntimeException("Failed to generate Ali RTC token", e);
        }
    }

    private String generateHMACSHA256(String data, String key) throws Exception {
        javax.crypto.Mac mac = javax.crypto.Mac.getInstance("HmacSHA256");
        javax.crypto.spec.SecretKeySpec secretKeySpec = new javax.crypto.spec.SecretKeySpec(key.getBytes(), "HmacSHA256");
        mac.init(secretKeySpec);
        byte[] hash = mac.doFinal(data.getBytes());
        return Base64.getEncoder().encodeToString(hash);
    }
}
```

### 1.2 修改主Token服务

**修改文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/service/TokenService.java`

**修改前**:

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/service/TokenService.java
@Service
public class TokenService {

    @Value("${agora.app.id}")
    private String appId;

    @Value("${agora.app.certificate}")
    private String appCertificate;

    public String generateToken(String channel, String uid) {
        // 原有的Agora Token生成逻辑
        return generateAgoraToken(appId, appCertificate, channel, uid, 3600);
    }

    private String generateAgoraToken(String appId, String appCertificate, String channel, String uid, int expireTime) {
        // Agora Token生成实现
        // ...
    }
}
```

**修改后**:

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/service/TokenService.java
@Service
public class TokenService {

    @Autowired
    private AgoraTokenService agoraTokenService;

    @Autowired
    private AliTokenService aliTokenService;

    public String generateToken(String channel, String uid, String rtcType) {
        if ("ali".equals(rtcType)) {
            return aliTokenService.generateToken(channel, uid);
        } else {
            return agoraTokenService.generateToken(channel, uid);
        }
    }

    // 保持向后兼容
    public String generateToken(String channel, String uid) {
        return generateToken(channel, uid, "agora");
    }
}
```

### 1.3 创建AgoraTokenService

**新增文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/service/AgoraTokenService.java`

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/service/AgoraTokenService.java
package com.agora.tenframework.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

@Service
public class AgoraTokenService {

    @Value("${agora.app.id}")
    private String appId;

    @Value("${agora.app.certificate}")
    private String appCertificate;

    public String generateToken(String channel, String uid) {
        // 原有的Agora Token生成逻辑
        return generateAgoraToken(appId, appCertificate, channel, uid, 3600);
    }

    private String generateAgoraToken(String appId, String appCertificate, String channel, String uid, int expireTime) {
        // Agora Token生成实现
        // 保持原有的Agora Token生成逻辑
        // ...
    }
}
```

## 2. RTM管理器修改

### 2.1 导入语句修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
import AgoraRTM, { type RTMClient, type RTMStreamChannel } from "agora-rtm"
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
import RTM, { type RTMClient } from "@dingrtc/rtm"
```

### 2.2 RTM客户端创建修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
const rtm = new AgoraRTM.RTM(appId, String(userId), {
  logLevel: "debug",
});
await rtm.login({ token });
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
const rtm = new RTM();
await rtm.join({
  appId,
  userName: `user-${userId}`,
  channel,
  uid: String(userId),
  token,
});
```

### 2.3 频道订阅修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
const subscribeResult = await rtm.subscribe(channel, {
  withMessage: true,
  withPresence: true,
  beQuiet: false,
  withMetadata: true,
  withLock: true,
});
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
// 阿里云RTM在join时已经自动订阅频道，无需额外订阅
console.log("[RTM] Join channel success!");
```

### 2.4 消息发布修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
await this._client?.publish(this.channel, JSON.stringify(msg), {
  customType: "PainTxt",
});
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
await this._client?.publish(this.channel, JSON.stringify(msg), {
  customType: "PainTxt",
});
```

### 2.5 事件监听修改

**修改前**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
private _listenRtmEvents() {
  this._client!.addEventListener("message", this.handleRtmMessage.bind(this));
  this._client!.addEventListener("presence", this.handleRtmPresence.bind(this));
}
```

**修改后**:

```typescript
// ai_agents/playground/src/manager/rtm/index.ts
private _listenRtmEvents() {
  // 阿里云RTM对应的事件监听
  this._client!.on("message", this.handleRtmMessage.bind(this));
  this._client!.on("presence", this.handleRtmPresence.bind(this));
}
```

## 3. TokenController.java 修改

### 3.1 修改API接口

**修改文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/controller/TokenController.java`

**修改前**:

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/controller/TokenController.java
@RestController
@RequestMapping("/api/token")
public class TokenController {

    @Autowired
    private TokenService tokenService;

    @PostMapping("/generate")
    public ResponseEntity<String> generateToken(@RequestBody TokenRequest request) {
        String token = tokenService.generateToken(request.getChannel(), request.getUid());
        return ResponseEntity.ok(token);
    }
}
```

**修改后**:

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/controller/TokenController.java
@RestController
@RequestMapping("/api/token")
public class TokenController {

    @Autowired
    private TokenService tokenService;

    @PostMapping("/generate")
    public ResponseEntity<String> generateToken(
            @RequestBody TokenRequest request,
            @RequestParam(value = "rtcType", defaultValue = "agora") String rtcType) {

        String token = tokenService.generateToken(request.getChannel(), request.getUid(), rtcType);
        return ResponseEntity.ok(token);
    }
}
```

### 3.2 修改TokenRequest类

**修改文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/model/TokenRequest.java`

**修改前**:

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/model/TokenRequest.java
public class TokenRequest {
    private String channel;
    private String uid;

    // getters and setters
}
```

**修改后**:

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/model/TokenRequest.java
public class TokenRequest {
    private String channel;
    private String uid;
    private String rtcType; // 新增字段

    // getters and setters
    public String getRtcType() {
        return rtcType != null ? rtcType : "agora";
    }

    public void setRtcType(String rtcType) {
        this.rtcType = rtcType;
    }
}
```

## 4. 配置文件修改

### 4.1 application.yml 修改

**修改文件**: `ai_agents/addons/server/src/main/resources/application.yml`

**修改前**:

```yaml
# ai_agents/addons/server/src/main/resources/application.yml
agora:
  app:
    id: ${AGORA_APP_ID}
    certificate: ${AGORA_APP_CERTIFICATE}
```

**修改后**:

```yaml
# ai_agents/addons/server/src/main/resources/application.yml
agora:
  app:
    id: ${AGORA_APP_ID}
    certificate: ${AGORA_APP_CERTIFICATE}

ali:
  rtc:
    app:
      id: ${ALI_RTC_APP_ID}
      key: ${ALI_RTC_APP_KEY}
```

### 3.2 环境变量配置

**修改文件**: `ai_agents/addons/server/.env`

**修改前**:

```bash
# ai_agents/addons/server/.env
AGORA_APP_ID=your_agora_app_id
AGORA_APP_CERTIFICATE=your_agora_app_certificate
```

**修改后**:

```bash
# ai_agents/addons/server/.env
AGORA_APP_ID=your_agora_app_id
AGORA_APP_CERTIFICATE=your_agora_app_certificate
ALI_RTC_APP_ID=your_ali_rtc_app_id
ALI_RTC_APP_KEY=your_ali_rtc_app_key
```

## 4. 错误处理修改

### 4.1 添加错误处理

**修改文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/controller/TokenController.java`

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/controller/TokenController.java
@RestController
@RequestMapping("/api/token")
public class TokenController {

    @Autowired
    private TokenService tokenService;

    @PostMapping("/generate")
    public ResponseEntity<?> generateToken(
            @RequestBody TokenRequest request,
            @RequestParam(value = "rtcType", defaultValue = "agora") String rtcType) {

        try {
            // 验证参数
            if (request.getChannel() == null || request.getUid() == null) {
                return ResponseEntity.badRequest()
                    .body(new ErrorResponse("Missing required parameters: channel and uid"));
            }

            // 验证RTC类型
            if (!"agora".equals(rtcType) && !"ali".equals(rtcType)) {
                return ResponseEntity.badRequest()
                    .body(new ErrorResponse("Invalid rtcType. Must be 'agora' or 'ali'"));
            }

            String token = tokenService.generateToken(request.getChannel(), request.getUid(), rtcType);
            return ResponseEntity.ok(new TokenResponse(token, rtcType));

        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ErrorResponse("Failed to generate token: " + e.getMessage()));
        }
    }
}
```

### 4.2 添加响应类

**新增文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/model/TokenResponse.java`

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/model/TokenResponse.java
package com.agora.tenframework.model;

public class TokenResponse {
    private String token;
    private String rtcType;

    public TokenResponse(String token, String rtcType) {
        this.token = token;
        this.rtcType = rtcType;
    }

    // getters and setters
    public String getToken() {
        return token;
    }

    public void setToken(String token) {
        this.token = token;
    }

    public String getRtcType() {
        return rtcType;
    }

    public void setRtcType(String rtcType) {
        this.rtcType = rtcType;
    }
}
```

**新增文件**: `ai_agents/addons/server/src/main/java/com/agora/tenframework/model/ErrorResponse.java`

```java
// ai_agents/addons/server/src/main/java/com/agora/tenframework/model/ErrorResponse.java
package com.agora.tenframework.model;

public class ErrorResponse {
    private String error;

    public ErrorResponse(String error) {
        this.error = error;
    }

    // getters and setters
    public String getError() {
        return error;
    }

    public void setError(String error) {
        this.error = error;
    }
}
```

## 6. 关键修改要点

### 6.1 必须修改的文件

1. `ai_agents/addons/server/src/main/java/com/agora/tenframework/service/TokenService.java`
2. `ai_agents/addons/server/src/main/java/com/agora/tenframework/controller/TokenController.java`
3. `ai_agents/addons/server/src/main/java/com/agora/tenframework/model/TokenRequest.java`
4. `ai_agents/addons/server/src/main/resources/application.yml`
5. `ai_agents/addons/server/.env`

### 6.2 新增的文件

1. `ai_agents/addons/server/src/main/java/com/agora/tenframework/service/AliTokenService.java`
2. `ai_agents/addons/server/src/main/java/com/agora/tenframework/service/AgoraTokenService.java`
3. `ai_agents/addons/server/src/main/java/com/agora/tenframework/model/TokenResponse.java`
4. `ai_agents/addons/server/src/main/java/com/agora/tenframework/model/ErrorResponse.java`

### 6.3 修改顺序

1. 先添加配置文件
2. 再创建新的服务类
3. 然后修改主服务类
4. 最后修改控制器

### 6.4 注意事项

1. **保持向后兼容**: 保留原有的API接口
2. **错误处理**: 添加完整的错误处理
3. **参数验证**: 验证所有输入参数
